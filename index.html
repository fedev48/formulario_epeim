<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/survey-core@1.12.1/survey.core.min.js"></script>
    <script src="https://unpkg.com/survey-core@1.12.1/survey.i18n.min.js"></script>
    <script src="https://unpkg.com/survey-core@1.12.1/themes/index.min.js"></script>
    <script src="https://unpkg.com/survey-js-ui@1.12.1/survey-js-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.debug.js"></script>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
      import { getDatabase,ref, set, get, child} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBbzlfGZrmNZmrJ8sXHRydrjSU79HqczIw",
        authDomain: "fichainscripcionepeim.firebaseapp.com",
        projectId: "fichainscripcionepeim",
        storageBucket: "fichainscripcionepeim.appspot.com",
        messagingSenderId: "320404165497",
        appId: "1:320404165497:web:071e7edaeec9446a63d5a8"
      };
    
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

    function writeDB(results, modifier) {
        console.log(results);
        set(ref(db, 'students/' + findStudentName()+modifier), {
          Estudiante_inscripto: findStudentName(),
          Nivel: findChoiceText("levell-selection", 1),
          blob: JSON.stringify(results),
          Fecha: { ".sv": "timestamp" },
        })
        .then(() => {
          console.log("Document successfully written!");
        })

        

    }

    async function checkIfStudentExists(modifier) {
      const studentRef = ref(db, 'students/' + findStudentName()+modifier);
      const snapshot = await get(studentRef);
      return snapshot.exists();
    }

    async function verificarYGuardarEstudiante(sender, modifier = null) {
        let i;
        if (modifier === null) {
          i = "";
        } else {
          i = parseInt(modifier, 10);
          if (isNaN(i)) {
            i = 0;
          }
        }

        const estudianteExiste = await checkIfStudentExists(i === "" ? "" : i.toString());
        if (estudianteExiste) {
          console.log("El estudiante ya existe");
          i += 1;
          verificarYGuardarEstudiante(sender, i.toString());
        } else {
          console.log("El estudiante no existe");
          window.writeDB(sender, i === "" ? "" : i.toString());
        }
      }


  
    
      window.writeDB = writeDB;
      window.checkIfStudentExists = checkIfStudentExists;
      window.verificarYGuardarEstudiante = verificarYGuardarEstudiante;
      
      
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/survey-core@1.12.1/defaultV2.min.css" />
    <link rel="stylesheet" href ="./index.css" />
  </head>
  <body>
    <div id="titleContainer">
      <img src="./Assets/LOGO EPEIMM.png" alt="Logo Izquierdo" id="leftLogo">
      <h1 id="headerText">Escuela EPEIM - Forma de preinscripci√≥n</h1>
      <img src="./Assets/LOGO EPEIMM.png" alt="Logo Derecho" id="rightLogo">
    </div>
    <div id="surveyContainer">
      <div id="surveyElement"></div>
    </div>
    <script src="./json.js"></script>
    <script src="./theme.js"></script>
    <script src="./index.js"></script>
  </body>
</html>